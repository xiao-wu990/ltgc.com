<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>闲聊聊天室 - 专业聊天平台</title>
    <script src="https://js.pusher.com/8.4.0/pusher.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6cf7;
            --primary-light: #e8f0ff;
            --primary-gradient: linear-gradient(135deg, #4a6cf7, #6b8aff);
            --secondary-color: #6b8aff;
            --bg-color: #f8faff;
            --text-color: #2d3748;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --success-color: #0abf53;
            --warning-color: #ff9f43;
            --danger-color: #ff5e5e;
            --info-color: #4a6cf7;
            --shadow: 0 8px 20px -5px rgba(74, 108, 247, 0.15);
            --transition: all 0.3s ease;
        }

        .dark-mode {
            --primary-color: #6b8aff;
            --primary-light: #1e2b4d;
            --primary-gradient: linear-gradient(135deg, #6b8aff, #8ba6ff);
            --secondary-color: #8ba6ff;
            --bg-color: #141c33;
            --text-color: #e2e8f0;
            --card-bg: #1e2b4d;
            --border-color: #2d3e6d;
            --shadow: 0 8px 20px -5px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: var(--transition);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            background-image: 
                radial-gradient(var(--primary-light) 1px, transparent 1px);
            background-size: 30px 30px;
            background-position: 0 0;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 20px;
            height: 100vh;
        }

        /* 认证界面样式 */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            z-index: 1000;
        }

        .auth-box {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 35px;
            width: 90%;
            max-width: 450px;
            box-shadow: var(--shadow);
            transform: translateY(0);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            color: var(--primary-color);
            font-weight: 700;
        }

        .auth-header p {
            color: var(--text-color);
            opacity: 0.8;
            font-size: 16px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-radius: 15px;
            background-color: var(--primary-light);
            padding: 6px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-radius: 12px;
            font-weight: 600;
            color: var(--text-color);
        }

        .auth-tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-color);
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 16px;
        }

        .form-group input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.3);
        }

        .remember-me {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .remember-me input {
            margin-right: 10px;
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: var(--primary-gradient);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(74, 108, 247, 0.4);
        }

        /* 主界面样式 */
        .sidebar {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .chat-container {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 17px;
        }

        .user-badge {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
            background-color: var(--info-color);
            color: white;
        }

        .badge-dev {
            background-color: var(--danger-color);
        }

        .badge-admin {
            background-color: var(--warning-color);
        }

        .user-status {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .icon-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-light);
            color: var(--primary-color);
            border: none;
            cursor: pointer;
            font-size: 18px;
        }

        .icon-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .message-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 15px;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            padding: 15px 20px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
            animation: messageAppear 0.3s ease-out;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: var(--primary-gradient);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.other {
            background-color: var(--primary-light);
            color: var(--text-color);
            border-bottom-left-radius: 5px;
        }

        .message-info {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .message-system {
            text-align: center;
            margin: 15px 0;
            font-size: 0.95rem;
            opacity: 0.8;
            font-style: italic;
            color: var(--primary-color);
        }

        .input-area {
            display: flex;
            gap: 12px;
        }

        .message-input {
            flex-grow: 1;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 15px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 16px;
            resize: none;
            min-height: 55px;
            max-height: 150px;
        }

        .message-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.3);
        }

        .send-btn {
            padding: 0 25px;
            border: none;
            border-radius: 15px;
            background: var(--primary-gradient);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(74, 108, 247, 0.4);
        }

        .user-list {
            list-style: none;
            margin-top: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .user-item {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            background-color: var(--primary-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-item:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateX(5px);
        }

        .user-item.active {
            background: var(--primary-gradient);
            color: white;
        }

        .section-title {
            margin: 25px 0 20px;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--primary-color);
        }

        .actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 25px;
        }

        .action-btn {
            padding: 15px;
            border: none;
            border-radius: 12px;
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            text-align: left;
            transition: var(--transition);
        }

        .action-btn:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            transform: scale(0.9);
            animation: modalAppear 0.3s forwards;
            border: 1px solid var(--border-color);
        }

        @keyframes modalAppear {
            to {
                transform: scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-color);
        }

        .tabs {
            display: flex;
            margin-bottom: 25px;
            border-radius: 15px;
            background-color: var(--primary-light);
            padding: 6px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-radius: 12px;
            font-weight: 600;
            color: var(--text-color);
        }

        .tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: 2;
            }
            
            .main-content {
                order: 1;
            }
            
            .auth-box {
                width: 95%;
                padding: 25px;
            }
        }

        /* 滚动条样式 */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--primary-light);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        /* 安全相关样式 */
        .security-notice {
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* 群聊列表样式 */
        .group-list {
            list-style: none;
            margin-top: 15px;
            overflow-y: auto;
            max-height: 150px;
        }

        .group-item {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            background-color: var(--primary-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .group-item:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .group-name {
            font-weight: 600;
        }

        .group-code {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        /* 连接状态指示器 */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            background-color: var(--primary-light);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success-color);
        }

        .status-indicator.connecting {
            background-color: var(--warning-color);
        }

        .status-indicator.disconnected {
            background-color: var(--danger-color);
        }
    </style>
</head>
<body>
    <!-- 认证界面 -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <h1>闲聊聊天室</h1>
                <p>安全、便捷的实时聊天平台</p>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" id="loginTabBtn">登录</div>
                <div class="auth-tab" id="registerTabBtn">注册</div>
            </div>
            
            <div class="auth-form">
                <!-- 登录表单 -->
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginUsername">用户名</label>
                        <input type="text" id="loginUsername" placeholder="输入用户名" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">密码</label>
                        <input type="password" id="loginPassword" placeholder="输入密码" required>
                    </div>
                    <div class="remember-me">
                        <input type="checkbox" id="rememberMe">
                        <label for="rememberMe">30天内自动登录</label>
                    </div>
                    <button type="submit" class="auth-btn">登录</button>
                </form>
                
                <!-- 注册表单 -->
                <form id="registerForm" style="display: none;">
                    <div class="form-group">
                        <label for="registerUsername">用户名</label>
                        <input type="text" id="registerUsername" placeholder="输入用户名" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">密码</label>
                        <input type="password" id="registerPassword" placeholder="输入密码" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">确认密码</label>
                        <input type="password" id="confirmPassword" placeholder="再次输入密码" required>
                    </div>
                    <button type="submit" class="auth-btn">注册</button>
                </form>
            </div>
            <div class="security-notice">
                安全提示：请勿分享您的登录凭据
            </div>
        </div>
    </div>

    <!-- 主应用界面 -->
    <div class="app-container" id="appContainer" style="display: none;">
        <aside class="sidebar">
            <div class="user-info">
                <div class="avatar" id="userAvatar">U</div>
                <div class="user-details">
                    <div class="user-name">
                        <span id="usernameDisplay">用户名</span>
                        <span class="user-badge" id="userBadge" style="display: none;">开发者</span>
                    </div>
                    <div class="user-status" id="userStatus">在线</div>
                </div>
            </div>
            
            <h3 class="section-title"><i class="fas fa-users"></i> 在线用户 <span id="onlineCount">(0)</span></h3>
            <ul class="user-list" id="userList">
                <!-- 用户列表将通过JS动态添加 -->
            </ul>

            <h3 class="section-title"><i class="fas fa-comments"></i> 我的群聊</h3>
            <ul class="group-list" id="groupList">
                <!-- 群聊列表将通过JS动态添加 -->
            </ul>
            
            <div class="connection-status">
                <div class="status-indicator" id="connectionStatus"></div>
                <span id="connectionStatusText">已连接</span>
            </div>
            
            <div class="actions">
                <button class="action-btn btn-success" id="createGroupBtn">
                    <i class="fas fa-plus"></i> 创建群聊
                </button>
                <button class="action-btn" id="joinGroupBtn">
                    <i class="fas fa-sign-in-alt"></i> 加入群聊
                </button>
                <button class="action-btn btn-warning" id="adminPanelBtn">
                    <i class="fas fa-cog"></i> 管理面板
                </button>
                <button class="action-btn" id="settingsBtn">
                    <i class="fas fa-sliders-h"></i> 设置
                </button>
                <button class="action-btn btn-danger" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> 退出登录
                </button>
            </div>
        </aside>

        <main class="main-content">
            <div class="header">
                <h2 id="currentChatTitle">公共聊天室</h2>
                <div class="header-actions">
                    <button class="icon-btn" id="themeToggle">🌙</button>
                    <button class="icon-btn" id="notificationsBtn"><i class="fas fa-bell"></i></button>
                </div>
            </div>

            <div class="chat-container">
                <div class="message-area" id="messageArea">
                    <!-- 消息将通过JS动态添加 -->
                </div>
                <div class="input-area">
                    <textarea class="message-input" id="messageInput" placeholder="输入消息..." rows="1"></textarea>
                    <button class="send-btn" id="sendMessageBtn">
                        <i class="fas fa-paper-plane"></i> 发送
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- 管理面板模态框 -->
    <div class="modal" id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">管理面板</h2>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="broadcast">广播消息</div>
                <div class="tab" data-tab="banUser">封禁用户</div>
                <div class="tab" data-tab="userStats">用户统计</div>
                <div class="tab" data-tab="adminManager">管理员管理</div>
            </div>

            <div class="tab-content active" id="broadcastTab">
                <div class="form-group">
                    <label for="broadcastMessage">广播消息</label>
                    <textarea id="broadcastMessage" rows="3" placeholder="输入广播消息" class="message-input"></textarea>
                </div>
                <button class="auth-btn" id="sendBroadcastBtn">发送广播</button>
            </div>

            <div class="tab-content" id="banUserTab">
                <div class="form-group">
                    <label for="banUsername">用户名</label>
                    <input type="text" id="banUsername" placeholder="输入要封禁的用户名">
                </div>
                <div class="form-group">
                    <label for="banDuration">封禁时长</label>
                    <select id="banDuration">
                        <option value="1">1天</option>
                        <option value="7">7天</option>
                        <option value="30">30天</option>
                        <option value="permanent">永久</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="banReason">封禁原因</label>
                    <input type="text" id="banReason" placeholder="输入封禁原因">
                </div>
                <button class="auth-btn btn-danger" id="banUserBtn">封禁用户</button>
            </div>

            <div class="tab-content" id="userStatsTab">
                <div class="form-group">
                    <p>总用户数: <strong id="totalUsers">0</strong></p>
                </div>
                <div class="form-group">
                    <p>在线用户: <strong id="onlineUsers">0</strong></p>
                </div>
                <div class="form-group">
                    <p>群聊数量: <strong id="totalGroups">0</strong></p>
                </div>
                <div class="form-group">
                    <p>消息总数: <strong id="totalMessages">0</strong></p>
                </div>
            </div>

            <div class="tab-content" id="adminManagerTab">
                <div class="form-group">
                    <label for="adminUsername">用户名</label>
                    <input type="text" id="adminUsername" placeholder="输入要设为管理员的用户名">
                </div>
                <button class="auth-btn" id="setAdminBtn">设为管理员</button>
                <div class="form-group" style="margin-top: 20px;">
                    <label>当前管理员列表</label>
                    <ul id="adminList">
                        <li>加载中...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- 创建群聊模态框 -->
    <div class="modal" id="createGroupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">创建群聊</h2>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="groupName">群名称</label>
                <input type="text" id="groupName" placeholder="输入群名称">
            </div>
            <div class="form-group">
                <label for="groupCode">群代码 (可选)</label>
                <input type="text" id="groupCode" placeholder="输入群代码或留空自动生成">
            </div>
            <div class="form-group">
                <label for="groupPassword">群密码 (可选)</label>
                <input type="password" id="groupPassword" placeholder="输入群密码">
            </div>
            <button class="auth-btn" id="createGroupConfirmBtn">创建群聊</button>
        </div>
    </div>

    <!-- 加入群聊模态框 -->
    <div class="modal" id="joinGroupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">加入群聊</h2>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="joinGroupCode">群代码</label>
                <input type="text" id="joinGroupCode" placeholder="输入群代码">
            </div>
            <div class="form-group">
                <label for="joinGroupPassword">群密码 (如果需要)</label>
                <input type="password" id="joinGroupPassword" placeholder="输入群密码">
            </div>
            <button class="auth-btn" id="joinGroupConfirmBtn">加入群聊</button>
        </div>
    </div>

    <!-- 设置模态框 -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">设置</h2>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <label>主题模式</label>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="auth-btn" id="lightThemeBtn">浅色模式</button>
                    <button class="auth-btn" id="darkThemeBtn">深色模式</button>
                </div>
            </div>
            
            <div class="form-group">
                <label>消息通知</label>
                <div style="display: flex; align-items: center; margin-top: 10px;">
                    <input type="checkbox" id="notificationsEnabled" checked>
                    <label for="notificationsEnabled" style="margin-left: 10px;">启用消息通知</label>
                </div>
            </div>
            
            <div class="form-group">
                <label>消息声音</label>
                <div style="display: flex; align-items: center; margin-top: 10px;">
                    <input type="checkbox" id="messageSoundEnabled" checked>
                    <label for="messageSoundEnabled" style="margin-left: 10px;">启用消息提示音</label>
                </div>
            </div>
            
            <button class="auth-btn" id="saveSettingsBtn">保存设置</button>
        </div>
    </div>

    <script>
        // 安全配置 - 开发者凭据
        const DEVELOPER_CREDENTIALS = {
            username: "3530388417",
            password: "19996837879gxhkkzgly"
        };

        // Pusher配置
        const PUSHER_CONFIG = {
            key: 'b83af7c1b7c068f602a1',
            cluster: 'ap1',
            enabledTransports: ['ws', 'wss'],
            authEndpoint: '/pusher/auth' // 在实际应用中需要设置认证端点
        };

        // 全局状态
        let currentUser = null;
        let currentChannel = null;
        let isDeveloper = false;
        let isAdmin = false;
        let rememberMe = false;
        let pusher = null;
        let onlineUsers = [];
        let userGroups = [];
        let currentChat = 'public';
        let connectionStatus = document.getElementById('connectionStatus');
        let connectionStatusText = document.getElementById('connectionStatusText');

        // DOM元素
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const messageArea = document.getElementById('messageArea');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const userList = document.getElementById('userList');
        const groupList = document.getElementById('groupList');
        const themeToggle = document.getElementById('themeToggle');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const userAvatar = document.getElementById('userAvatar');
        const userBadge = document.getElementById('userBadge');
        const adminModal = document.getElementById('adminModal');
        const createGroupModal = document.getElementById('createGroupModal');
        const joinGroupModal = document.getElementById('joinGroupModal');
        const settingsModal = document.getElementById('settingsModal');
        const onlineCount = document.getElementById('onlineCount');
        const currentChatTitle = document.getElementById('currentChatTitle');

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // 初始化应用
        function initializeApp() {
            // 检查是否已登录（30天免登录）
            checkRememberedLogin();
            
            // 设置事件监听器
            setupEventListeners();
        }

        // 设置事件监听器
        function setupEventListeners() {
            // 标签切换
            document.getElementById('loginTabBtn').addEventListener('click', () => {
                switchAuthTab('login');
            });
            
            document.getElementById('registerTabBtn').addEventListener('click', () => {
                switchAuthTab('register');
            });
            
            // 登录按钮
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                login();
            });
            
            // 注册按钮
            registerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                register();
            });
            
            // 退出登录
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // 发送消息
            sendMessageBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
                
                // 自动调整文本区域高度
                setTimeout(() => {
                    messageInput.style.height = 'auto';
                    messageInput.style.height = (messageInput.scrollHeight) + 'px';
                }, 0);
            });
            
            // 主题切换
            themeToggle.addEventListener('click', toggleTheme);
            
            // 管理面板
            document.getElementById('adminPanelBtn').addEventListener('click', openAdminPanel);
            document.getElementById('sendBroadcastBtn').addEventListener('click', sendBroadcast);
            document.getElementById('banUserBtn').addEventListener('click', banUser);
            document.getElementById('setAdminBtn').addEventListener('click', setAdmin);
            
            // 群聊功能
            document.getElementById('createGroupBtn').addEventListener('click', () => {
                createGroupModal.style.display = 'flex';
            });
            
            document.getElementById('joinGroupBtn').addEventListener('click', () => {
                joinGroupModal.style.display = 'flex';
            });
            
            document.getElementById('createGroupConfirmBtn').addEventListener('click', createGroup);
            document.getElementById('joinGroupConfirmBtn').addEventListener('click', joinGroup);
            
            // 设置
            document.getElementById('settingsBtn').addEventListener('click', () => {
                settingsModal.style.display = 'flex';
            });
            
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            document.getElementById('lightThemeBtn').addEventListener('click', () => {
                document.body.classList.remove('dark-mode');
                themeToggle.textContent = '🌙';
                localStorage.setItem('darkMode', 'false');
            });
            
            document.getElementById('darkThemeBtn').addEventListener('click', () => {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = '☀️';
                localStorage.setItem('darkMode', 'true');
            });
            
            // 关闭模态框
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            // 标签切换（管理面板）
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    const tabContent = document.getElementById(tabName + 'Tab');
                    
                    // 移除所有active类
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                    
                    // 添加active类到当前标签
                    tab.classList.add('active');
                    tabContent.classList.add('active');
                });
            });
            
            // 点击模态框外部关闭
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                }
            });
        }

        // 切换认证标签
        function switchAuthTab(tab) {
            if (tab === 'login') {
                document.getElementById('loginTabBtn').classList.add('active');
                document.getElementById('registerTabBtn').classList.remove('active');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                document.getElementById('registerTabBtn').classList.add('active');
                document.getElementById('loginTabBtn').classList.remove('active');
                registerForm.style.display = 'block';
                loginForm.style.display = 'none';
            }
        }

        // 检查记住的登录状态
        function checkRememberedLogin() {
            const rememberedUser = localStorage.getItem('rememberedUser');
            const rememberTime = localStorage.getItem('rememberTime');
            
            if (rememberedUser && rememberTime) {
                const timeDiff = Date.now() - parseInt(rememberTime);
                const daysDiff = timeDiff / (1000 * 60 * 60 * 24);
                
                // 30天内免登录
                if (daysDiff < 30) {
                    currentUser = JSON.parse(rememberedUser);
                    initializeChat();
                    return true;
                } else {
                    // 清除过期的记住登录
                    localStorage.removeItem('rememberedUser');
                    localStorage.removeItem('rememberTime');
                }
            }
            return false;
        }

        // 登录功能
        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            rememberMe = document.getElementById('rememberMe').checked;
            
            if (username && password) {
                // 检查是否为开发者账号
                if (username === DEVELOPER_CREDENTIALS.username && password === DEVELOPER_CREDENTIALS.password) {
                    isDeveloper = true;
                }
                
                // 在实际应用中，这里应该调用API进行身份验证
                authenticateUser(username, password).then(userData => {
                    if (userData) {
                        currentUser = {
                            username: userData.username,
                            userId: userData.userId,
                            isAdmin: userData.isAdmin || false
                        };
                        
                        // 记住登录状态
                        if (rememberMe) {
                            localStorage.setItem('rememberedUser', JSON.stringify(currentUser));
                            localStorage.setItem('rememberTime', Date.now().toString());
                        }
                        
                        initializeChat();
                    } else {
                        alert('用户名或密码错误');
                    }
                }).catch(error => {
                    console.error('登录错误:', error);
                    alert('登录过程中发生错误');
                });
            } else {
                alert('请输入用户名和密码');
            }
        }

        // 模拟API身份验证
        async function authenticateUser(username, password) {
            // 在实际应用中，这里应该调用真实的后端API
            // 这里仅作演示用途
            return new Promise((resolve) => {
                setTimeout(() => {
                    // 模拟验证过程
                    if (username && password) {
                        resolve({
                            username: username,
                            userId: generateUserId(),
                            isAdmin: username === DEVELOPER_CREDENTIALS.username
                        });
                    } else {
                        resolve(null);
                    }
                }, 500);
            });
        }

        // 注册功能
        function register() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                alert('密码不匹配');
                return;
            }
            
            // 在实际应用中，这里应该调用API进行用户注册
            registerUser(username, password).then(success => {
                if (success) {
                    alert('注册成功，请登录');
                    // 切换到登录表单
                    switchAuthTab('login');
                } else {
                    alert('注册失败，用户名可能已被使用');
                }
            }).catch(error => {
                console.error('注册错误:', error);
                alert('注册过程中发生错误');
            });
        }

        // 模拟API用户注册
        async function registerUser(username, password) {
            // 在实际应用中，这里应该调用真实的后端API
            // 这里仅作演示用途
            return new Promise((resolve) => {
                setTimeout(() => {
                    // 模拟注册过程
                    resolve(username && password);
                }, 500);
            });
        }

        // 初始化聊天
        function initializeChat() {
            // 更新UI
            usernameDisplay.textContent = currentUser.username;
            userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
            
            // 检查用户角色
            checkUserRole();
            
            // 显示主界面，隐藏登录界面
            authContainer.style.display = 'none';
            appContainer.style.display = 'grid';
            
            // 初始化Pusher
            initializePusher();
            
            // 加载用户群聊
            loadUserGroups();
            
            // 添加欢迎消息
            addSystemMessage(`欢迎 ${currentUser.username} 加入闲聊聊天室！`);
        }

        // 初始化Pusher
        function initializePusher() {
            // 更新连接状态
            updateConnectionStatus('connecting');
            
            pusher = new Pusher(PUSHER_CONFIG.key, {
                cluster: PUSHER_CONFIG.cluster,
                enabledTransports: PUSHER_CONFIG.enabledTransports,
                authEndpoint: PUSHER_CONFIG.authEndpoint
            });
            
            // 监听连接状态变化
            pusher.connection.bind('state_change', function(states) {
                updateConnectionStatus(states.current);
            });
            
            // 订阅公共频道
            currentChannel = pusher.subscribe('presence-chat');
            
            // 监听用户加入
            currentChannel.bind('pusher:subscription_succeeded', function(members) {
                updateOnlineUsers(members);
                updateConnectionStatus('connected');
            });
            
            // 监听用户加入事件
            currentChannel.bind('pusher:member_added', function(member) {
                addSystemMessage(`${member.info.username} 加入了聊天`);
                updateOnlineUsers(pusher.channel('presence-chat').members);
            });
            
            // 监听用户离开事件
            currentChannel.bind('pusher:member_removed', function(member) {
                addSystemMessage(`${member.info.username} 离开了聊天`);
                updateOnlineUsers(pusher.channel('presence-chat').members);
            });
            
            // 监听新消息
            currentChannel.bind('client-message', function(data) {
                // 只显示当前聊天室的消息
                if (data.chat === currentChat) {
                    addMessageToChat(data);
                }
            });
            
            // 监听广播消息
            currentChannel.bind('client-broadcast', function(data) {
                addBroadcastMessage(data.message, data.from);
            });
            
            // 通知服务器用户已加入
            notifyUserJoin();
        }

        // 更新连接状态
        function updateConnectionStatus(status) {
            connectionStatus.className = 'status-indicator';
            
            switch(status) {
                case 'connected':
                    connectionStatus.classList.add('connected');
                    connectionStatusText.textContent = '已连接';
                    break;
                case 'connecting':
                    connectionStatus.classList.add('connecting');
                    connectionStatusText.textContent = '连接中...';
                    break;
                case 'disconnected':
                case 'failed':
                case 'unavailable':
                    connectionStatus.classList.add('disconnected');
                    connectionStatusText.textContent = '连接断开';
                    break;
                default:
                    connectionStatusText.textContent = status;
            }
        }

        // 更新在线用户列表
        function updateOnlineUsers(members) {
            onlineUsers = [];
            userList.innerHTML = '';
            
            // 转换成员对象为数组
            for (let id in members.members) {
                onlineUsers.push(members.members[id]);
            }
            
            onlineUsers.forEach(user => {
                const userItem = document.createElement('li');
                userItem.classList.add('user-item');
                
                const userName = document.createElement('span');
                userName.textContent = user.username;
                
                userItem.appendChild(userName);
                
                if (user.isDeveloper) {
                    const badge = document.createElement('span');
                    badge.classList.add('user-badge', 'badge-dev');
                    badge.textContent = '开发者';
                    userItem.appendChild(badge);
                } else if (user.isAdmin) {
                    const badge = document.createElement('span');
                    badge.classList.add('user-badge', 'badge-admin');
                    badge.textContent = '管理员';
                    userItem.appendChild(badge);
                }
                
                userList.appendChild(userItem);
            });
            
            // 更新在线用户计数
            onlineCount.textContent = `(${onlineUsers.length})`;
            document.getElementById('onlineUsers').textContent = onlineUsers.length;
        }

        // 加载用户群聊
        function loadUserGroups() {
            // 模拟API调用获取用户群聊
            getUserGroups().then(groups => {
                userGroups = groups;
                updateGroupList();
            }).catch(error => {
                console.error('加载群聊错误:', error);
            });
        }

        // 模拟API获取用户群聊
        async function getUserGroups() {
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve([
                        { id: 1, name: '技术交流', code: '1234' },
                        { id: 2, name: '游戏群', code: '5678' },
                        { id: 3, name: '学习小组', code: '9012' }
                    ]);
                }, 500);
            });
        }

        // 更新群聊列表
        function updateGroupList() {
            groupList.innerHTML = '';
            
            if (userGroups.length === 0) {
                groupList.innerHTML = '<li style="padding: 15px; text-align: center; opacity: 0.7;">您还没有加入任何群聊</li>';
                return;
            }
            
            userGroups.forEach(group => {
                const groupItem = document.createElement('li');
                groupItem.classList.add('group-item');
                groupItem.dataset.groupId = group.id;
                
                groupItem.innerHTML = `
                    <div>
                        <div class="group-name">${group.name}</div>
                        <div class="group-code">代码: ${group.code}</div>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                `;
                
                groupItem.addEventListener('click', () => {
                    switchToGroupChat(group);
                });
                
                groupList.appendChild(groupItem);
            });
        }

        // 切换到群聊
        function switchToGroupChat(group) {
            currentChat = 'group-' + group.id;
            currentChatTitle.textContent = group.name;
            messageArea.innerHTML = '';
            addSystemMessage(`已切换到群聊: ${group.name}`);
        }

        // 退出登录
        function logout() {
            // 通知服务器用户离开
            notifyUserLeave();
            
            // 取消订阅频道
            if (currentChannel) {
                pusher.unsubscribe('presence-chat');
            }
            
            // 清除用户数据
            localStorage.removeItem('rememberedUser');
            localStorage.removeItem('rememberTime');
            currentUser = null;
            isDeveloper = false;
            isAdmin = false;
            onlineUsers = [];
            userGroups = [];
            
            // 清空聊天和用户列表
            messageArea.innerHTML = '';
            userList.innerHTML = '';
            groupList.innerHTML = '';
            
            // 显示登录界面，隐藏主界面
            authContainer.style.display = 'flex';
            appContainer.style.display = 'none';
            
            // 重置表单
            loginForm.reset();
            registerForm.reset();
        }

        // 通知服务器用户离开
        function notifyUserLeave() {
            // 在实际应用中，这里应该调用API通知服务器用户离开
            console.log('用户离开:', currentUser.username);
        }

        // 发送消息
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            // 创建消息数据
            const messageData = {
                username: currentUser.username,
                userId: currentUser.userId,
                message: message,
                timestamp: new Date().toISOString(),
                chat: currentChat
            };
            
            // 在实际应用中，这里应该调用API发送消息
            // 这里使用Pusher的客户端事件进行演示
            if (currentChannel) {
                currentChannel.trigger('client-message', messageData);
                
                // 添加到自己的聊天界面
                addMessageToChat(messageData);
                
                // 清空输入框并重置高度
                messageInput.value = '';
                messageInput.style.height = 'auto';
            }
        }

        // 添加消息到聊天区域
        function addMessageToChat(data) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            
            if (data.userId === currentUser.userId) {
                messageDiv.classList.add('user');
            } else {
                messageDiv.classList.add('other');
            }
            
            const messageInfo = document.createElement('div');
            messageInfo.classList.add('message-info');
            messageInfo.innerHTML = `<span>${data.username}</span> <span>${new Date(data.timestamp).toLocaleTimeString()}</span>`;
            
            const messageText = document.createElement('div');
            messageText.textContent = data.message;
            
            messageDiv.appendChild(messageInfo);
            messageDiv.appendChild(messageText);
            messageArea.appendChild(messageDiv);
            
            // 滚动到底部
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        // 添加系统消息
        function addSystemMessage(message) {
            const systemMessage = document.createElement('div');
            systemMessage.classList.add('message-system');
            systemMessage.textContent = message;
            messageArea.appendChild(systemMessage);
            
            // 滚动到底部
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        // 添加广播消息
        function addBroadcastMessage(message, from) {
            const broadcastMessage = document.createElement('div');
            broadcastMessage.classList.add('message-system');
            broadcastMessage.innerHTML = `<strong>📢 广播来自 ${from}:</strong> ${message}`;
            messageArea.appendChild(broadcastMessage);
            
            // 滚动到底部
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        // 打开管理面板
        function openAdminPanel() {
            if (!isDeveloper && !isAdmin) {
                alert('您没有权限访问管理面板');
                return;
            }
            
            adminModal.style.display = 'flex';
            
            // 更新统计信息
            updateAdminStats();
        }

        // 更新管理统计信息
        function updateAdminStats() {
            // 在实际应用中，这里应该调用API获取实时数据
            document.getElementById('totalUsers').textContent = '加载中...';
            document.getElementById('onlineUsers').textContent = onlineUsers.length;
            document.getElementById('totalGroups').textContent = '加载中...';
            document.getElementById('totalMessages').textContent = '加载中...';
            
            // 模拟API调用获取统计数据
            setTimeout(() => {
                document.getElementById('totalUsers').textContent = Math.floor(Math.random() * 100) + 50;
                document.getElementById('totalGroups').textContent = Math.floor(Math.random() * 20) + 5;
                document.getElementById('totalMessages').textContent = Math.floor(Math.random() * 1000) + 500;
                
                // 更新管理员列表
                updateAdminList();
            }, 1000);
        }

        // 更新管理员列表
        function updateAdminList() {
            const adminList = document.getElementById('adminList');
            adminList.innerHTML = '';
            
            // 模拟管理员列表
            const admins = [
                { username: '开发者', isDeveloper: true },
                { username: '管理员1', isDeveloper: false },
                { username: '管理员2', isDeveloper: false }
            ];
            
            admins.forEach(admin => {
                const li = document.createElement('li');
                li.textContent = admin.username + (admin.isDeveloper ? ' (开发者)' : ' (管理员)');
                adminList.appendChild(li);
            });
        }

        // 发送广播
        function sendBroadcast() {
            const message = document.getElementById('broadcastMessage').value;
            if (!message) {
                alert('请输入广播消息');
                return;
            }
            
            // 在实际应用中，这里应该调用API发送广播
            // 这里使用Pusher的客户端事件进行演示
            if (currentChannel) {
                currentChannel.trigger('client-broadcast', {
                    message: message,
                    from: isDeveloper ? '开发者' : '管理员'
                });
                
                alert('广播已发送');
                document.getElementById('broadcastMessage').value = '';
                adminModal.style.display = 'none';
            }
        }

        // 封禁用户
        function banUser() {
            const username = document.getElementById('banUsername').value;
            const duration = document.getElementById('banDuration').value;
            const reason = document.getElementById('banReason').value;
            
            if (!username) {
                alert('请输入要封禁的用户名');
                return;
            }
            
            // 在实际应用中，这里应该调用API封禁用户
            banUserAccount(username, duration, reason).then(() => {
                alert(`用户 ${username} 已被封禁`);
                
                // 清空表单
                document.getElementById('banUsername').value = '';
                document.getElementById('banReason').value = '';
                adminModal.style.display = 'none';
            }).catch(error => {
                console.error('封禁用户错误:', error);
                alert('封禁用户失败');
            });
        }

        // 模拟API封禁用户
        async function banUserAccount(username, duration, reason) {
            // 在实际应用中，这里应该调用真实的后端API
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log('封禁用户:', username, duration, reason);
                    resolve();
                }, 500);
            });
        }

        // 设置管理员
        function setAdmin() {
            const username = document.getElementById('adminUsername').value;
            
            if (!username) {
                alert('请输入要设为管理员的用户名');
                return;
            }
            
            // 在实际应用中，这里应该调用API设置管理员
            setUserAsAdmin(username).then(() => {
                alert(`用户 ${username} 已被设为管理员`);
                document.getElementById('adminUsername').value = '';
                updateAdminList();
            }).catch(error => {
                console.error('设置管理员错误:', error);
                alert('设置管理员失败');
            });
        }

        // 模拟API设置管理员
        async function setUserAsAdmin(username) {
            // 在实际应用中，这里应该调用真实的后端API
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log('设置管理员:', username);
                    resolve();
                }, 500);
            });
        }

        // 创建群聊
        function createGroup() {
            const groupName = document.getElementById('groupName').value;
            const groupCode = document.getElementById('groupCode').value || generateGroupCode();
            const groupPassword = document.getElementById('groupPassword').value;
            
            if (!groupName) {
                alert('请输入群名称');
                return;
            }
            
            // 在实际应用中，这里应该调用API创建群聊
            createChatGroup(groupName, groupCode, groupPassword).then(() => {
                alert(`群聊 ${groupName} 创建成功，代码: ${groupCode}`);
                
                // 添加到用户群聊列表
                userGroups.push({ id: Date.now(), name: groupName, code: groupCode });
                updateGroupList();
                
                // 关闭模态框并清空表单
                createGroupModal.style.display = 'none';
                document.getElementById('groupName').value = '';
                document.getElementById('groupCode').value = '';
                document.getElementById('groupPassword').value = '';
            }).catch(error => {
                console.error('创建群聊错误:', error);
                alert('创建群聊失败');
            });
        }

        // 加入群聊
        function joinGroup() {
            const groupCode = document.getElementById('joinGroupCode').value;
            const groupPassword = document.getElementById('joinGroupPassword').value;
            
            if (!groupCode) {
                alert('请输入群代码');
                return;
            }
            
            // 在实际应用中，这里应该调用API加入群聊
            joinChatGroup(groupCode, groupPassword).then(group => {
                if (group) {
                    alert(`成功加入群聊: ${group.name}`);
                    
                    // 添加到用户群聊列表
                    userGroups.push(group);
                    updateGroupList();
                    
                    // 关闭模态框并清空表单
                    joinGroupModal.style.display = 'none';
                    document.getElementById('joinGroupCode').value = '';
                    document.getElementById('joinGroupPassword').value = '';
                } else {
                    alert('加入群聊失败，请检查群代码和密码');
                }
            }).catch(error => {
                console.error('加入群聊错误:', error);
                alert('加入群聊失败');
            });
        }

        // 模拟API加入群聊
        async function joinChatGroup(groupCode, groupPassword) {
            // 在实际应用中，这里应该调用真实的后端API
            return new Promise((resolve) => {
                setTimeout(() => {
                    // 模拟加入群聊
                    if (groupCode === '1234') {
                        resolve({ id: 1, name: '技术交流', code: '1234' });
                    } else if (groupCode === '5678') {
                        resolve({ id: 2, name: '游戏群', code: '5678' });
                    } else if (groupCode === '9012') {
                        resolve({ id: 3, name: '学习小组', code: '9012' });
                    } else {
                        resolve(null);
                    }
                }, 500);
            });
        }

        // 模拟API创建群聊
        async function createChatGroup(groupName, groupCode, groupPassword) {
            // 在实际应用中，这里应该调用真实的后端API
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log('创建群聊:', groupName, groupCode);
                    resolve();
                }, 500);
            });
        }

        // 保存设置
        function saveSettings() {
            const notificationsEnabled = document.getElementById('notificationsEnabled').checked;
            const messageSoundEnabled = document.getElementById('messageSoundEnabled').checked;
            
            // 在实际应用中，这里应该调用API保存设置
            saveUserSettings(notificationsEnabled, messageSoundEnabled).then(() => {
                alert('设置已保存');
                settingsModal.style.display = 'none';
            }).catch(error => {
                console.error('保存设置错误:', error);
                alert('保存设置失败');
            });
        }

        // 模拟API保存设置
        async function saveUserSettings(notificationsEnabled, messageSoundEnabled) {
            // 在实际应用中，这里应该调用真实的后端API
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log('保存设置:', { notificationsEnabled, messageSoundEnabled });
                    resolve();
                }, 500);
            });
        }

        // 切换主题
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            themeToggle.textContent = document.body.classList.contains('dark-mode') ? '☀️' : '🌙';
            
            // 保存主题偏好
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        // 检查用户角色
        function checkUserRole() {
            // 检查是否为开发者
            if (currentUser.username === DEVELOPER_CREDENTIALS.username) {
                isDeveloper = true;
                userBadge.textContent = "开发者";
                userBadge.style.display = "block";
                userBadge.classList.add("badge-dev");
            }
            
            // 检查是否为管理员
            if (currentUser.isAdmin) {
                isAdmin = true;
                userBadge.textContent = "管理员";
                userBadge.style.display = "block";
                userBadge.classList.add("badge-admin");
            }
            
            // 检查保存的主题偏好
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = '☀️';
            }
        }

        // 通知服务器用户加入
        function notifyUserJoin() {
            // 在实际应用中，这里应该调用API通知服务器用户加入
            console.log('用户加入:', currentUser.username);
        }

        // 工具函数：生成用户ID
        function generateUserId() {
            return Math.floor(Math.random() * 1000000000).toString();
        }

        // 工具函数：生成群代码
        function generateGroupCode() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }
    </script>
</body>
</html>