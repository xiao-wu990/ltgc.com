<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—²èŠèŠå¤©å®¤ - ä¸“ä¸šèŠå¤©å¹³å°</title>
    <script src="https://js.pusher.com/8.4.0/pusher.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6cf7;
            --primary-light: #e8f0ff;
            --primary-gradient: linear-gradient(135deg, #4a6cf7, #6b8aff);
            --secondary-color: #6b8aff;
            --bg-color: #f8faff;
            --text-color: #2d3748;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --success-color: #0abf53;
            --warning-color: #ff9f43;
            --danger-color: #ff5e5e;
            --info-color: #4a6cf7;
            --shadow: 0 8px 20px -5px rgba(74, 108, 247, 0.15);
            --transition: all 0.3s ease;
        }

        .dark-mode {
            --primary-color: #6b8aff;
            --primary-light: #1e2b4d;
            --primary-gradient: linear-gradient(135deg, #6b8aff, #8ba6ff);
            --secondary-color: #8ba6ff;
            --bg-color: #141c33;
            --text-color: #e2e8f0;
            --card-bg: #1e2b4d;
            --border-color: #2d3e6d;
            --shadow: 0 8px 20px -5px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            transition: var(--transition);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            background-image: 
                radial-gradient(var(--primary-light) 1px, transparent 1px);
            background-size: 30px 30px;
            background-position: 0 0;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 3fr;
            gap: 20px;
            height: 100vh;
        }

        /* è®¤è¯ç•Œé¢æ ·å¼ */
        .auth-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--primary-gradient);
            z-index: 1000;
        }

        .auth-box {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 35px;
            width: 90%;
            max-width: 450px;
            box-shadow: var(--shadow);
            transform: translateY(0);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            color: var(--primary-color);
            font-weight: 700;
        }

        .auth-header p {
            color: var(--text-color);
            opacity: 0.8;
            font-size: 16px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 25px;
            border-radius: 15px;
            background-color: var(--primary-light);
            padding: 6px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-radius: 12px;
            font-weight: 600;
            color: var(--text-color);
        }

        .auth-tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-color);
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 16px;
        }

        .form-group input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.3);
        }

        .remember-me {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .remember-me input {
            margin-right: 10px;
        }

        .auth-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: var(--primary-gradient);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(74, 108, 247, 0.4);
        }

        /* ä¸»ç•Œé¢æ ·å¼ */
        .sidebar {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .chat-container {
            background-color: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: var(--shadow);
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary-gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 17px;
        }

        .user-badge {
            font-size: 0.75rem;
            padding: 4px 10px;
            border-radius: 20px;
            background-color: var(--info-color);
            color: white;
        }

        .badge-dev {
            background-color: var(--danger-color);
        }

        .badge-admin {
            background-color: var(--warning-color);
        }

        .user-status {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .icon-btn {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--primary-light);
            color: var(--primary-color);
            border: none;
            cursor: pointer;
            font-size: 18px;
        }

        .icon-btn:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .message-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 15px;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            padding: 15px 20px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            position: relative;
            animation: messageAppear 0.3s ease-out;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            background: var(--primary-gradient);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.other {
            background-color: var(--primary-light);
            color: var(--text-color);
            border-bottom-left-radius: 5px;
        }

        .message-info {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .message-system {
            text-align: center;
            margin: 15px 0;
            font-size: 0.95rem;
            opacity: 0.8;
            font-style: italic;
            color: var(--primary-color);
        }

        .input-area {
            display: flex;
            gap: 12px;
        }

        .message-input {
            flex-grow: 1;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 15px;
            background-color: var(--card-bg);
            color: var(--text-color);
            font-size: 16px;
            resize: none;
            min-height: 55px;
            max-height: 150px;
        }

        .message-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.3);
        }

        .send-btn {
            padding: 0 25px;
            border: none;
            border-radius: 15px;
            background: var(--primary-gradient);
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(74, 108, 247, 0.4);
        }

        .user-list {
            list-style: none;
            margin-top: 20px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .user-item {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 10px;
            background-color: var(--primary-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-item:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateX(5px);
        }

        .user-item.active {
            background: var(--primary-gradient);
            color: white;
        }

        .section-title {
            margin: 25px 0 20px;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--primary-color);
        }

        .actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 25px;
        }

        .action-btn {
            padding: 15px;
            border: none;
            border-radius: 12px;
            background-color: var(--primary-light);
            color: var(--primary-color);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            text-align: left;
            transition: var(--transition);
        }

        .action-btn:hover {
            background-color: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow);
            transform: scale(0.9);
            animation: modalAppear 0.3s forwards;
            border: 1px solid var(--border-color);
        }

        @keyframes modalAppear {
            to {
                transform: scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-color);
        }

        .tabs {
            display: flex;
            margin-bottom: 25px;
            border-radius: 15px;
            background-color: var(--primary-light);
            padding: 6px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-radius: 12px;
            font-weight: 600;
            color: var(--text-color);
        }

        .tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                order: 2;
            }
            
            .main-content {
                order: 1;
            }
            
            .auth-box {
                width: 95%;
                padding: 25px;
            }
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--primary-light);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-color);
        }

        /* å®‰å…¨ç›¸å…³æ ·å¼ */
        .security-notice {
            text-align: center;
            padding: 10px;
            font-size: 12px;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* ç¾¤èŠåˆ—è¡¨æ ·å¼ */
        .group-list {
            list-style: none;
            margin-top: 15px;
            overflow-y: auto;
            max-height: 150px;
        }

        .group-item {
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            background-color: var(--primary-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .group-item:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .group-name {
            font-weight: 600;
        }

        .group-code {
            font-size: 0.8rem;
            opacity: 0.7;
        }

        /* è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 20px;
            background-color: var(--primary-light);
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success-color);
        }

        .status-indicator.connecting {
            background-color: var(--warning-color);
        }

        .status-indicator.disconnected {
            background-color: var(--danger-color);
        }
    </style>
</head>
<body>
    <!-- è®¤è¯ç•Œé¢ -->
    <div class="auth-container" id="authContainer">
        <div class="auth-box">
            <div class="auth-header">
                <h1>é—²èŠèŠå¤©å®¤</h1>
                <p>å®‰å…¨ã€ä¾¿æ·çš„å®æ—¶èŠå¤©å¹³å°</p>
            </div>
            
            <div class="auth-tabs">
                <div class="auth-tab active" id="loginTabBtn">ç™»å½•</div>
                <div class="auth-tab" id="registerTabBtn">æ³¨å†Œ</div>
            </div>
            
            <div class="auth-form">
                <!-- ç™»å½•è¡¨å• -->
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginUsername">ç”¨æˆ·å</label>
                        <input type="text" id="loginUsername" placeholder="è¾“å…¥ç”¨æˆ·å" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">å¯†ç </label>
                        <input type="password" id="loginPassword" placeholder="è¾“å…¥å¯†ç " required>
                    </div>
                    <div class="remember-me">
                        <input type="checkbox" id="rememberMe">
                        <label for="rememberMe">30å¤©å†…è‡ªåŠ¨ç™»å½•</label>
                    </div>
                    <button type="submit" class="auth-btn">ç™»å½•</button>
                </form>
                
                <!-- æ³¨å†Œè¡¨å• -->
                <form id="registerForm" style="display: none;">
                    <div class="form-group">
                        <label for="registerUsername">ç”¨æˆ·å</label>
                        <input type="text" id="registerUsername" placeholder="è¾“å…¥ç”¨æˆ·å" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">å¯†ç </label>
                        <input type="password" id="registerPassword" placeholder="è¾“å…¥å¯†ç " required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">ç¡®è®¤å¯†ç </label>
                        <input type="password" id="confirmPassword" placeholder="å†æ¬¡è¾“å…¥å¯†ç " required>
                    </div>
                    <button type="submit" class="auth-btn">æ³¨å†Œ</button>
                </form>
            </div>
            <div class="security-notice">
                å®‰å…¨æç¤ºï¼šè¯·å‹¿åˆ†äº«æ‚¨çš„ç™»å½•å‡­æ®
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨ç•Œé¢ -->
    <div class="app-container" id="appContainer" style="display: none;">
        <aside class="sidebar">
            <div class="user-info">
                <div class="avatar" id="userAvatar">U</div>
                <div class="user-details">
                    <div class="user-name">
                        <span id="usernameDisplay">ç”¨æˆ·å</span>
                        <span class="user-badge" id="userBadge" style="display: none;">å¼€å‘è€…</span>
                    </div>
                    <div class="user-status" id="userStatus">åœ¨çº¿</div>
                </div>
            </div>
            
            <h3 class="section-title"><i class="fas fa-users"></i> åœ¨çº¿ç”¨æˆ· <span id="onlineCount">(0)</span></h3>
            <ul class="user-list" id="userList">
                <!-- ç”¨æˆ·åˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
            </ul>

            <h3 class="section-title"><i class="fas fa-comments"></i> æˆ‘çš„ç¾¤èŠ</h3>
            <ul class="group-list" id="groupList">
                <!-- ç¾¤èŠåˆ—è¡¨å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
            </ul>
            
            <div class="connection-status">
                <div class="status-indicator" id="connectionStatus"></div>
                <span id="connectionStatusText">å·²è¿æ¥</span>
            </div>
            
            <div class="actions">
                <button class="action-btn btn-success" id="createGroupBtn">
                    <i class="fas fa-plus"></i> åˆ›å»ºç¾¤èŠ
                </button>
                <button class="action-btn" id="joinGroupBtn">
                    <i class="fas fa-sign-in-alt"></i> åŠ å…¥ç¾¤èŠ
                </button>
                <button class="action-btn btn-warning" id="adminPanelBtn">
                    <i class="fas fa-cog"></i> ç®¡ç†é¢æ¿
                </button>
                <button class="action-btn" id="settingsBtn">
                    <i class="fas fa-sliders-h"></i> è®¾ç½®
                </button>
                <button class="action-btn btn-danger" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> é€€å‡ºç™»å½•
                </button>
            </div>
        </aside>

        <main class="main-content">
            <div class="header">
                <h2 id="currentChatTitle">å…¬å…±èŠå¤©å®¤</h2>
                <div class="header-actions">
                    <button class="icon-btn" id="themeToggle">ğŸŒ™</button>
                    <button class="icon-btn" id="notificationsBtn"><i class="fas fa-bell"></i></button>
                </div>
            </div>

            <div class="chat-container">
                <div class="message-area" id="messageArea">
                    <!-- æ¶ˆæ¯å°†é€šè¿‡JSåŠ¨æ€æ·»åŠ  -->
                </div>
                <div class="input-area">
                    <textarea class="message-input" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
                    <button class="send-btn" id="sendMessageBtn">
                        <i class="fas fa-paper-plane"></i> å‘é€
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- ç®¡ç†é¢æ¿æ¨¡æ€æ¡† -->
    <div class="modal" id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ç®¡ç†é¢æ¿</h2>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="broadcast">å¹¿æ’­æ¶ˆæ¯</div>
                <div class="tab" data-tab="banUser">å°ç¦ç”¨æˆ·</div>
                <div class="tab" data-tab="userStats">ç”¨æˆ·ç»Ÿè®¡</div>
                <div class="tab" data-tab="adminManager">ç®¡ç†å‘˜ç®¡ç†</div>
            </div>

            <div class="tab-content active" id="broadcastTab">
                <div class="form-group">
                    <label for="broadcastMessage">å¹¿æ’­æ¶ˆæ¯</label>
                    <textarea id="broadcastMessage" rows="3" placeholder="è¾“å…¥å¹¿æ’­æ¶ˆæ¯" class="message-input"></textarea>
                </div>
                <button class="auth-btn" id="sendBroadcastBtn">å‘é€å¹¿æ’­</button>
            </div>

            <div class="tab-content" id="banUserTab">
                <div class="form-group">
                    <label for="banUsername">ç”¨æˆ·å</label>
                    <input type="text" id="banUsername" placeholder="è¾“å…¥è¦å°ç¦çš„ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label for="banDuration">å°ç¦æ—¶é•¿</label>
                    <select id="banDuration">
                        <option value="1">1å¤©</option>
                        <option value="7">7å¤©</option>
                        <option value="30">30å¤©</option>
                        <option value="permanent">æ°¸ä¹…</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="banReason">å°ç¦åŸå› </label>
                    <input type="text" id="banReason" placeholder="è¾“å…¥å°ç¦åŸå› ">
                </div>
                <button class="auth-btn btn-danger" id="banUserBtn">å°ç¦ç”¨æˆ·</button>
            </div>

            <div class="tab-content" id="userStatsTab">
                <div class="form-group">
                    <p>æ€»ç”¨æˆ·æ•°: <strong id="totalUsers">0</strong></p>
                </div>
                <div class="form-group">
                    <p>åœ¨çº¿ç”¨æˆ·: <strong id="onlineUsers">0</strong></p>
                </div>
                <div class="form-group">
                    <p>ç¾¤èŠæ•°é‡: <strong id="totalGroups">0</strong></p>
                </div>
                <div class="form-group">
                    <p>æ¶ˆæ¯æ€»æ•°: <strong id="totalMessages">0</strong></p>
                </div>
            </div>

            <div class="tab-content" id="adminManagerTab">
                <div class="form-group">
                    <label for="adminUsername">ç”¨æˆ·å</label>
                    <input type="text" id="adminUsername" placeholder="è¾“å…¥è¦è®¾ä¸ºç®¡ç†å‘˜çš„ç”¨æˆ·å">
                </div>
                <button class="auth-btn" id="setAdminBtn">è®¾ä¸ºç®¡ç†å‘˜</button>
                <div class="form-group" style="margin-top: 20px;">
                    <label>å½“å‰ç®¡ç†å‘˜åˆ—è¡¨</label>
                    <ul id="adminList">
                        <li>åŠ è½½ä¸­...</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºç¾¤èŠæ¨¡æ€æ¡† -->
    <div class="modal" id="createGroupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">åˆ›å»ºç¾¤èŠ</h2>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="groupName">ç¾¤åç§°</label>
                <input type="text" id="groupName" placeholder="è¾“å…¥ç¾¤åç§°">
            </div>
            <div class="form-group">
                <label for="groupCode">ç¾¤ä»£ç  (å¯é€‰)</label>
                <input type="text" id="groupCode" placeholder="è¾“å…¥ç¾¤ä»£ç æˆ–ç•™ç©ºè‡ªåŠ¨ç”Ÿæˆ">
            </div>
            <div class="form-group">
                <label for="groupPassword">ç¾¤å¯†ç  (å¯é€‰)</label>
                <input type="password" id="groupPassword" placeholder="è¾“å…¥ç¾¤å¯†ç ">
            </div>
            <button class="auth-btn" id="createGroupConfirmBtn">åˆ›å»ºç¾¤èŠ</button>
        </div>
    </div>

    <!-- åŠ å…¥ç¾¤èŠæ¨¡æ€æ¡† -->
    <div class="modal" id="joinGroupModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">åŠ å…¥ç¾¤èŠ</h2>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="joinGroupCode">ç¾¤ä»£ç </label>
                <input type="text" id="joinGroupCode" placeholder="è¾“å…¥ç¾¤ä»£ç ">
            </div>
            <div class="form-group">
                <label for="joinGroupPassword">ç¾¤å¯†ç  (å¦‚æœéœ€è¦)</label>
                <input type="password" id="joinGroupPassword" placeholder="è¾“å…¥ç¾¤å¯†ç ">
            </div>
            <button class="auth-btn" id="joinGroupConfirmBtn">åŠ å…¥ç¾¤èŠ</button>
        </div>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">è®¾ç½®</h2>
                <button class="close-modal">&times;</button>
            </div>
            
            <div class="form-group">
                <label>ä¸»é¢˜æ¨¡å¼</label>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button class="auth-btn" id="lightThemeBtn">æµ…è‰²æ¨¡å¼</button>
                    <button class="auth-btn" id="darkThemeBtn">æ·±è‰²æ¨¡å¼</button>
                </div>
            </div>
            
            <div class="form-group">
                <label>æ¶ˆæ¯é€šçŸ¥</label>
                <div style="display: flex; align-items: center; margin-top: 10px;">
                    <input type="checkbox" id="notificationsEnabled" checked>
                    <label for="notificationsEnabled" style="margin-left: 10px;">å¯ç”¨æ¶ˆæ¯é€šçŸ¥</label>
                </div>
            </div>
            
            <div class="form-group">
                <label>æ¶ˆæ¯å£°éŸ³</label>
                <div style="display: flex; align-items: center; margin-top: 10px;">
                    <input type="checkbox" id="messageSoundEnabled" checked>
                    <label for="messageSoundEnabled" style="margin-left: 10px;">å¯ç”¨æ¶ˆæ¯æç¤ºéŸ³</label>
                </div>
            </div>
            
            <button class="auth-btn" id="saveSettingsBtn">ä¿å­˜è®¾ç½®</button>
        </div>
    </div>

    <script>
        // å®‰å…¨é…ç½® - å¼€å‘è€…å‡­æ®
        const DEVELOPER_CREDENTIALS = {
            username: "3530388417",
            password: "19996837879gxhkkzgly"
        };

        // Pusheré…ç½®
        const PUSHER_CONFIG = {
            key: 'b83af7c1b7c068f602a1',
            cluster: 'ap1',
            enabledTransports: ['ws', 'wss'],
            authEndpoint: '/pusher/auth' // åœ¨å®é™…åº”ç”¨ä¸­éœ€è¦è®¾ç½®è®¤è¯ç«¯ç‚¹
        };

        // å…¨å±€çŠ¶æ€
        let currentUser = null;
        let currentChannel = null;
        let isDeveloper = false;
        let isAdmin = false;
        let rememberMe = false;
        let pusher = null;
        let onlineUsers = [];
        let userGroups = [];
        let currentChat = 'public';
        let connectionStatus = document.getElementById('connectionStatus');
        let connectionStatusText = document.getElementById('connectionStatusText');

        // DOMå…ƒç´ 
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const messageArea = document.getElementById('messageArea');
        const messageInput = document.getElementById('messageInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');
        const userList = document.getElementById('userList');
        const groupList = document.getElementById('groupList');
        const themeToggle = document.getElementById('themeToggle');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const userAvatar = document.getElementById('userAvatar');
        const userBadge = document.getElementById('userBadge');
        const adminModal = document.getElementById('adminModal');
        const createGroupModal = document.getElementById('createGroupModal');
        const joinGroupModal = document.getElementById('joinGroupModal');
        const settingsModal = document.getElementById('settingsModal');
        const onlineCount = document.getElementById('onlineCount');
        const currentChatTitle = document.getElementById('currentChatTitle');

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        // åˆå§‹åŒ–åº”ç”¨
        function initializeApp() {
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆ30å¤©å…ç™»å½•ï¼‰
            checkRememberedLogin();
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            // æ ‡ç­¾åˆ‡æ¢
            document.getElementById('loginTabBtn').addEventListener('click', () => {
                switchAuthTab('login');
            });
            
            document.getElementById('registerTabBtn').addEventListener('click', () => {
                switchAuthTab('register');
            });
            
            // ç™»å½•æŒ‰é’®
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                login();
            });
            
            // æ³¨å†ŒæŒ‰é’®
            registerForm.addEventListener('submit', function(e) {
                e.preventDefault();
                register();
            });
            
            // é€€å‡ºç™»å½•
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // å‘é€æ¶ˆæ¯
            sendMessageBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
                
                // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬åŒºåŸŸé«˜åº¦
                setTimeout(() => {
                    messageInput.style.height = 'auto';
                    messageInput.style.height = (messageInput.scrollHeight) + 'px';
                }, 0);
            });
            
            // ä¸»é¢˜åˆ‡æ¢
            themeToggle.addEventListener('click', toggleTheme);
            
            // ç®¡ç†é¢æ¿
            document.getElementById('adminPanelBtn').addEventListener('click', openAdminPanel);
            document.getElementById('sendBroadcastBtn').addEventListener('click', sendBroadcast);
            document.getElementById('banUserBtn').addEventListener('click', banUser);
            document.getElementById('setAdminBtn').addEventListener('click', setAdmin);
            
            // ç¾¤èŠåŠŸèƒ½
            document.getElementById('createGroupBtn').addEventListener('click', () => {
                createGroupModal.style.display = 'flex';
            });
            
            document.getElementById('joinGroupBtn').addEventListener('click', () => {
                joinGroupModal.style.display = 'flex';
            });
            
            document.getElementById('createGroupConfirmBtn').addEventListener('click', createGroup);
            document.getElementById('joinGroupConfirmBtn').addEventListener('click', joinGroup);
            
            // è®¾ç½®
            document.getElementById('settingsBtn').addEventListener('click', () => {
                settingsModal.style.display = 'flex';
            });
            
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            document.getElementById('lightThemeBtn').addEventListener('click', () => {
                document.body.classList.remove('dark-mode');
                themeToggle.textContent = 'ğŸŒ™';
                localStorage.setItem('darkMode', 'false');
            });
            
            document.getElementById('darkThemeBtn').addEventListener('click', () => {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = 'â˜€ï¸';
                localStorage.setItem('darkMode', 'true');
            });
            
            // å…³é—­æ¨¡æ€æ¡†
            document.querySelectorAll('.close-modal').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                });
            });
            
            // æ ‡ç­¾åˆ‡æ¢ï¼ˆç®¡ç†é¢æ¿ï¼‰
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    const tabContent = document.getElementById(tabName + 'Tab');
                    
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                    
                    // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾
                    tab.classList.add('active');
                    tabContent.classList.add('active');
                });
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            window.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = 'none';
                    });
                }
            });
        }

        // åˆ‡æ¢è®¤è¯æ ‡ç­¾
        function switchAuthTab(tab) {
            if (tab === 'login') {
                document.getElementById('loginTabBtn').classList.add('active');
                document.getElementById('registerTabBtn').classList.remove('active');
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
            } else {
                document.getElementById('registerTabBtn').classList.add('active');
                document.getElementById('loginTabBtn').classList.remove('active');
                registerForm.style.display = 'block';
                loginForm.style.display = 'none';
            }
        }

        // æ£€æŸ¥è®°ä½çš„ç™»å½•çŠ¶æ€
        function checkRememberedLogin() {
            const rememberedUser = localStorage.getItem('rememberedUser');
            const rememberTime = localStorage.getItem('rememberTime');
            
            if (rememberedUser && rememberTime) {
                const timeDiff = Date.now() - parseInt(rememberTime);
                const daysDiff = timeDiff / (1000 * 60 * 60 * 24);
                
                // 30å¤©å†…å…ç™»å½•
                if (daysDiff < 30) {
                    currentUser = JSON.parse(rememberedUser);
                    initializeChat();
                    return true;
                } else {
                    // æ¸…é™¤è¿‡æœŸçš„è®°ä½ç™»å½•
                    localStorage.removeItem('rememberedUser');
                    localStorage.removeItem('rememberTime');
                }
            }
            return false;
        }

        // ç™»å½•åŠŸèƒ½
        function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            rememberMe = document.getElementById('rememberMe').checked;
            
            if (username && password) {
                // æ£€æŸ¥æ˜¯å¦ä¸ºå¼€å‘è€…è´¦å·
                if (username === DEVELOPER_CREDENTIALS.username && password === DEVELOPER_CREDENTIALS.password) {
                    isDeveloper = true;
                }
                
                // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨APIè¿›è¡Œèº«ä»½éªŒè¯
                authenticateUser(username, password).then(userData => {
                    if (userData) {
                        currentUser = {
                            username: userData.username,
                            userId: userData.userId,
                            isAdmin: userData.isAdmin || false
                        };
                        
                        // è®°ä½ç™»å½•çŠ¶æ€
                        if (rememberMe) {
                            localStorage.setItem('rememberedUser', JSON.stringify(currentUser));
                            localStorage.setItem('rememberTime', Date.now().toString());
                        }
                        
                        initializeChat();
                    } else {
                        alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
                    }
                }).catch(error => {
                    console.error('ç™»å½•é”™è¯¯:', error);
                    alert('ç™»å½•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
                });
            } else {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
            }
        }

        // æ¨¡æ‹ŸAPIèº«ä»½éªŒè¯
        async function authenticateUser(username, password) {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨çœŸå®çš„åç«¯API
            // è¿™é‡Œä»…ä½œæ¼”ç¤ºç”¨é€”
            return new Promise((resolve) => {
                setTimeout(() => {
                    // æ¨¡æ‹ŸéªŒè¯è¿‡ç¨‹
                    if (username && password) {
                        resolve({
                            username: username,
                            userId: generateUserId(),
                            isAdmin: username === DEVELOPER_CREDENTIALS.username
                        });
                    } else {
                        resolve(null);
                    }
                }, 500);
            });
        }

        // æ³¨å†ŒåŠŸèƒ½
        function register() {
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (password !== confirmPassword) {
                alert('å¯†ç ä¸åŒ¹é…');
                return;
            }
            
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨APIè¿›è¡Œç”¨æˆ·æ³¨å†Œ
            registerUser(username, password).then(success => {
                if (success) {
                    alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
                    // åˆ‡æ¢åˆ°ç™»å½•è¡¨å•
                    switchAuthTab('login');
                } else {
                    alert('æ³¨å†Œå¤±è´¥ï¼Œç”¨æˆ·åå¯èƒ½å·²è¢«ä½¿ç”¨');
                }
            }).catch(error => {
                console.error('æ³¨å†Œé”™è¯¯:', error);
                alert('æ³¨å†Œè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
            });
        }

        // æ¨¡æ‹ŸAPIç”¨æˆ·æ³¨å†Œ
        async function registerUser(username, password) {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨çœŸå®çš„åç«¯API
            // è¿™é‡Œä»…ä½œæ¼”ç¤ºç”¨é€”
            return new Promise((resolve) => {
                setTimeout(() => {
                    // æ¨¡æ‹Ÿæ³¨å†Œè¿‡ç¨‹
                    resolve(username && password);
                }, 500);
            });
        }

        // åˆå§‹åŒ–èŠå¤©
        function initializeChat() {
            // æ›´æ–°UI
            usernameDisplay.textContent = currentUser.username;
            userAvatar.textContent = currentUser.username.charAt(0).toUpperCase();
            
            // æ£€æŸ¥ç”¨æˆ·è§’è‰²
            checkUserRole();
            
            // æ˜¾ç¤ºä¸»ç•Œé¢ï¼Œéšè—ç™»å½•ç•Œé¢
            authContainer.style.display = 'none';
            appContainer.style.display = 'grid';
            
            // åˆå§‹åŒ–Pusher
            initializePusher();
            
            // åŠ è½½ç”¨æˆ·ç¾¤èŠ
            loadUserGroups();
            
            // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
            addSystemMessage(`æ¬¢è¿ ${currentUser.username} åŠ å…¥é—²èŠèŠå¤©å®¤ï¼`);
        }

        // åˆå§‹åŒ–Pusher
        function initializePusher() {
            // æ›´æ–°è¿æ¥çŠ¶æ€
            updateConnectionStatus('connecting');
            
            pusher = new Pusher(PUSHER_CONFIG.key, {
                cluster: PUSHER_CONFIG.cluster,
                enabledTransports: PUSHER_CONFIG.enabledTransports,
                authEndpoint: PUSHER_CONFIG.authEndpoint
            });
            
            // ç›‘å¬è¿æ¥çŠ¶æ€å˜åŒ–
            pusher.connection.bind('state_change', function(states) {
                updateConnectionStatus(states.current);
            });
            
            // è®¢é˜…å…¬å…±é¢‘é“
            currentChannel = pusher.subscribe('presence-chat');
            
            // ç›‘å¬ç”¨æˆ·åŠ å…¥
            currentChannel.bind('pusher:subscription_succeeded', function(members) {
                updateOnlineUsers(members);
                updateConnectionStatus('connected');
            });
            
            // ç›‘å¬ç”¨æˆ·åŠ å…¥äº‹ä»¶
            currentChannel.bind('pusher:member_added', function(member) {
                addSystemMessage(`${member.info.username} åŠ å…¥äº†èŠå¤©`);
                updateOnlineUsers(pusher.channel('presence-chat').members);
            });
            
            // ç›‘å¬ç”¨æˆ·ç¦»å¼€äº‹ä»¶
            currentChannel.bind('pusher:member_removed', function(member) {
                addSystemMessage(`${member.info.username} ç¦»å¼€äº†èŠå¤©`);
                updateOnlineUsers(pusher.channel('presence-chat').members);
            });
            
            // ç›‘å¬æ–°æ¶ˆæ¯
            currentChannel.bind('client-message', function(data) {
                // åªæ˜¾ç¤ºå½“å‰èŠå¤©å®¤çš„æ¶ˆæ¯
                if (data.chat === currentChat) {
                    addMessageToChat(data);
                }
            });
            
            // ç›‘å¬å¹¿æ’­æ¶ˆæ¯
            currentChannel.bind('client-broadcast', function(data) {
                addBroadcastMessage(data.message, data.from);
            });
            
            // é€šçŸ¥æœåŠ¡å™¨ç”¨æˆ·å·²åŠ å…¥
            notifyUserJoin();
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status) {
            connectionStatus.className = 'status-indicator';
            
            switch(status) {
                case 'connected':
                    connectionStatus.classList.add('connected');
                    connectionStatusText.textContent = 'å·²è¿æ¥';
                    break;
                case 'connecting':
                    connectionStatus.classList.add('connecting');
                    connectionStatusText.textContent = 'è¿æ¥ä¸­...';
                    break;
                case 'disconnected':
                case 'failed':
                case 'unavailable':
                    connectionStatus.classList.add('disconnected');
                    connectionStatusText.textContent = 'è¿æ¥æ–­å¼€';
                    break;
                default:
                    connectionStatusText.textContent = status;
            }
        }

        // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
        function updateOnlineUsers(members) {
            onlineUsers = [];
            userList.innerHTML = '';
            
            // è½¬æ¢æˆå‘˜å¯¹è±¡ä¸ºæ•°ç»„
            for (let id in members.members) {
                onlineUsers.push(members.members[id]);
            }
            
            onlineUsers.forEach(user => {
                const userItem = document.createElement('li');
                userItem.classList.add('user-item');
                
                const userName = document.createElement('span');
                userName.textContent = user.username;
                
                userItem.appendChild(userName);
                
                if (user.isDeveloper) {
                    const badge = document.createElement('span');
                    badge.classList.add('user-badge', 'badge-dev');
                    badge.textContent = 'å¼€å‘è€…';
                    userItem.appendChild(badge);
                } else if (user.isAdmin) {
                    const badge = document.createElement('span');
                    badge.classList.add('user-badge', 'badge-admin');
                    badge.textContent = 'ç®¡ç†å‘˜';
                    userItem.appendChild(badge);
                }
                
                userList.appendChild(userItem);
            });
            
            // æ›´æ–°åœ¨çº¿ç”¨æˆ·è®¡æ•°
            onlineCount.textContent = `(${onlineUsers.length})`;
            document.getElementById('onlineUsers').textContent = onlineUsers.length;
        }

        // åŠ è½½ç”¨æˆ·ç¾¤èŠ
        function loadUserGroups() {
            // æ¨¡æ‹ŸAPIè°ƒç”¨è·å–ç”¨æˆ·ç¾¤èŠ
            getUserGroups().then(groups => {
                userGroups = groups;
                updateGroupList();
            }).catch(error => {
                console.error('åŠ è½½ç¾¤èŠé”™è¯¯:', error);
            });
        }

        // æ¨¡æ‹ŸAPIè·å–ç”¨æˆ·ç¾¤èŠ
        async function getUserGroups() {
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve([
                        { id: 1, name: 'æŠ€æœ¯äº¤æµ', code: '1234' },
                        { id: 2, name: 'æ¸¸æˆç¾¤', code: '5678' },
                        { id: 3, name: 'å­¦ä¹ å°ç»„', code: '9012' }
                    ]);
                }, 500);
            });
        }

        // æ›´æ–°ç¾¤èŠåˆ—è¡¨
        function updateGroupList() {
            groupList.innerHTML = '';
            
            if (userGroups.length === 0) {
                groupList.innerHTML = '<li style="padding: 15px; text-align: center; opacity: 0.7;">æ‚¨è¿˜æ²¡æœ‰åŠ å…¥ä»»ä½•ç¾¤èŠ</li>';
                return;
            }
            
            userGroups.forEach(group => {
                const groupItem = document.createElement('li');
                groupItem.classList.add('group-item');
                groupItem.dataset.groupId = group.id;
                
                groupItem.innerHTML = `
                    <div>
                        <div class="group-name">${group.name}</div>
                        <div class="group-code">ä»£ç : ${group.code}</div>
                    </div>
                    <i class="fas fa-chevron-right"></i>
                `;
                
                groupItem.addEventListener('click', () => {
                    switchToGroupChat(group);
                });
                
                groupList.appendChild(groupItem);
            });
        }

        // åˆ‡æ¢åˆ°ç¾¤èŠ
        function switchToGroupChat(group) {
            currentChat = 'group-' + group.id;
            currentChatTitle.textContent = group.name;
            messageArea.innerHTML = '';
            addSystemMessage(`å·²åˆ‡æ¢åˆ°ç¾¤èŠ: ${group.name}`);
        }

        // é€€å‡ºç™»å½•
        function logout() {
            // é€šçŸ¥æœåŠ¡å™¨ç”¨æˆ·ç¦»å¼€
            notifyUserLeave();
            
            // å–æ¶ˆè®¢é˜…é¢‘é“
            if (currentChannel) {
                pusher.unsubscribe('presence-chat');
            }
            
            // æ¸…é™¤ç”¨æˆ·æ•°æ®
            localStorage.removeItem('rememberedUser');
            localStorage.removeItem('rememberTime');
            currentUser = null;
            isDeveloper = false;
            isAdmin = false;
            onlineUsers = [];
            userGroups = [];
            
            // æ¸…ç©ºèŠå¤©å’Œç”¨æˆ·åˆ—è¡¨
            messageArea.innerHTML = '';
            userList.innerHTML = '';
            groupList.innerHTML = '';
            
            // æ˜¾ç¤ºç™»å½•ç•Œé¢ï¼Œéšè—ä¸»ç•Œé¢
            authContainer.style.display = 'flex';
            appContainer.style.display = 'none';
            
            // é‡ç½®è¡¨å•
            loginForm.reset();
            registerForm.reset();
        }

        // é€šçŸ¥æœåŠ¡å™¨ç”¨æˆ·ç¦»å¼€
        function notifyUserLeave() {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨APIé€šçŸ¥æœåŠ¡å™¨ç”¨æˆ·ç¦»å¼€
            console.log('ç”¨æˆ·ç¦»å¼€:', currentUser.username);
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            // åˆ›å»ºæ¶ˆæ¯æ•°æ®
            const messageData = {
                username: currentUser.username,
                userId: currentUser.userId,
                message: message,
                timestamp: new Date().toISOString(),
                chat: currentChat
            };
            
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨APIå‘é€æ¶ˆæ¯
            // è¿™é‡Œä½¿ç”¨Pusherçš„å®¢æˆ·ç«¯äº‹ä»¶è¿›è¡Œæ¼”ç¤º
            if (currentChannel) {
                currentChannel.trigger('client-message', messageData);
                
                // æ·»åŠ åˆ°è‡ªå·±çš„èŠå¤©ç•Œé¢
                addMessageToChat(messageData);
                
                // æ¸…ç©ºè¾“å…¥æ¡†å¹¶é‡ç½®é«˜åº¦
                messageInput.value = '';
                messageInput.style.height = 'auto';
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        function addMessageToChat(data) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');
            
            if (data.userId === currentUser.userId) {
                messageDiv.classList.add('user');
            } else {
                messageDiv.classList.add('other');
            }
            
            const messageInfo = document.createElement('div');
            messageInfo.classList.add('message-info');
            messageInfo.innerHTML = `<span>${data.username}</span> <span>${new Date(data.timestamp).toLocaleTimeString()}</span>`;
            
            const messageText = document.createElement('div');
            messageText.textContent = data.message;
            
            messageDiv.appendChild(messageInfo);
            messageDiv.appendChild(messageText);
            messageArea.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(message) {
            const systemMessage = document.createElement('div');
            systemMessage.classList.add('message-system');
            systemMessage.textContent = message;
            messageArea.appendChild(systemMessage);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        // æ·»åŠ å¹¿æ’­æ¶ˆæ¯
        function addBroadcastMessage(message, from) {
            const broadcastMessage = document.createElement('div');
            broadcastMessage.classList.add('message-system');
            broadcastMessage.innerHTML = `<strong>ğŸ“¢ å¹¿æ’­æ¥è‡ª ${from}:</strong> ${message}`;
            messageArea.appendChild(broadcastMessage);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            messageArea.scrollTop = messageArea.scrollHeight;
        }

        // æ‰“å¼€ç®¡ç†é¢æ¿
        function openAdminPanel() {
            if (!isDeveloper && !isAdmin) {
                alert('æ‚¨æ²¡æœ‰æƒé™è®¿é—®ç®¡ç†é¢æ¿');
                return;
            }
            
            adminModal.style.display = 'flex';
            
            // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
            updateAdminStats();
        }

        // æ›´æ–°ç®¡ç†ç»Ÿè®¡ä¿¡æ¯
        function updateAdminStats() {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨APIè·å–å®æ—¶æ•°æ®
            document.getElementById('totalUsers').textContent = 'åŠ è½½ä¸­...';
            document.getElementById('onlineUsers').textContent = onlineUsers.length;
            document.getElementById('totalGroups').textContent = 'åŠ è½½ä¸­...';
            document.getElementById('totalMessages').textContent = 'åŠ è½½ä¸­...';
            
            // æ¨¡æ‹ŸAPIè°ƒç”¨è·å–ç»Ÿè®¡æ•°æ®
            setTimeout(() => {
                document.getElementById('totalUsers').textContent = Math.floor(Math.random() * 100) + 50;
                document.getElementById('totalGroups').textContent = Math.floor(Math.random() * 20) + 5;
                document.getElementById('totalMessages').textContent = Math.floor(Math.random() * 1000) + 500;
                
                // æ›´æ–°ç®¡ç†å‘˜åˆ—è¡¨
                updateAdminList();
            }, 1000);
        }

        // æ›´æ–°ç®¡ç†å‘˜åˆ—è¡¨
        function updateAdminList() {
            const adminList = document.getElementById('adminList');
            adminList.innerHTML = '';
            
            // æ¨¡æ‹Ÿç®¡ç†å‘˜åˆ—è¡¨
            const admins = [
                { username: 'å¼€å‘è€…', isDeveloper: true },
                { username: 'ç®¡ç†å‘˜1', isDeveloper: false },
                { username: 'ç®¡ç†å‘˜2', isDeveloper: false }
            ];
            
            admins.forEach(admin => {
                const li = document.createElement('li');
                li.textContent = admin.username + (admin.isDeveloper ? ' (å¼€å‘è€…)' : ' (ç®¡ç†å‘˜)');
                adminList.appendChild(li);
            });
        }

        // å‘é€å¹¿æ’­
        function sendBroadcast() {
            const message = document.getElementById('broadcastMessage').value;
            if (!message) {
                alert('è¯·è¾“å…¥å¹¿æ’­æ¶ˆæ¯');
                return;
            }
            
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨APIå‘é€å¹¿æ’­
            // è¿™é‡Œä½¿ç”¨Pusherçš„å®¢æˆ·ç«¯äº‹ä»¶è¿›è¡Œæ¼”ç¤º
            if (currentChannel) {
                currentChannel.trigger('client-broadcast', {
                    message: message,
                    from: isDeveloper ? 'å¼€å‘è€…' : 'ç®¡ç†å‘˜'
                });
                
                alert('å¹¿æ’­å·²å‘é€');
                document.getElementById('broadcastMessage').value = '';
                adminModal.style.display = 'none';
            }
        }

        // å°ç¦ç”¨æˆ·
        function banUser() {
            const username = document.getElementById('banUsername').value;
            const duration = document.getElementById('banDuration').value;
            const reason = document.getElementById('banReason').value;
            
            if (!username) {
                alert('è¯·è¾“å…¥è¦å°ç¦çš„ç”¨æˆ·å');
                return;
            }
            
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨APIå°ç¦ç”¨æˆ·
            banUserAccount(username, duration, reason).then(() => {
                alert(`ç”¨æˆ· ${username} å·²è¢«å°ç¦`);
                
                // æ¸…ç©ºè¡¨å•
                document.getElementById('banUsername').value = '';
                document.getElementById('banReason').value = '';
                adminModal.style.display = 'none';
            }).catch(error => {
                console.error('å°ç¦ç”¨æˆ·é”™è¯¯:', error);
                alert('å°ç¦ç”¨æˆ·å¤±è´¥');
            });
        }

        // æ¨¡æ‹ŸAPIå°ç¦ç”¨æˆ·
        async function banUserAccount(username, duration, reason) {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨çœŸå®çš„åç«¯API
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log('å°ç¦ç”¨æˆ·:', username, duration, reason);
                    resolve();
                }, 500);
            });
        }

        // è®¾ç½®ç®¡ç†å‘˜
        function setAdmin() {
            const username = document.getElementById('adminUsername').value;
            
            if (!username) {
                alert('è¯·è¾“å…¥è¦è®¾ä¸ºç®¡ç†å‘˜çš„ç”¨æˆ·å');
                return;
            }
            
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨APIè®¾ç½®ç®¡ç†å‘˜
            setUserAsAdmin(username).then(() => {
                alert(`ç”¨æˆ· ${username} å·²è¢«è®¾ä¸ºç®¡ç†å‘˜`);
                document.getElementById('adminUsername').value = '';
                updateAdminList();
            }).catch(error => {
                console.error('è®¾ç½®ç®¡ç†å‘˜é”™è¯¯:', error);
                alert('è®¾ç½®ç®¡ç†å‘˜å¤±è´¥');
            });
        }

        // æ¨¡æ‹ŸAPIè®¾ç½®ç®¡ç†å‘˜
        async function setUserAsAdmin(username) {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨çœŸå®çš„åç«¯API
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log('è®¾ç½®ç®¡ç†å‘˜:', username);
                    resolve();
                }, 500);
            });
        }

        // åˆ›å»ºç¾¤èŠ
        function createGroup() {
            const groupName = document.getElementById('groupName').value;
            const groupCode = document.getElementById('groupCode').value || generateGroupCode();
            const groupPassword = document.getElementById('groupPassword').value;
            
            if (!groupName) {
                alert('è¯·è¾“å…¥ç¾¤åç§°');
                return;
            }
            
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨APIåˆ›å»ºç¾¤èŠ
            createChatGroup(groupName, groupCode, groupPassword).then(() => {
                alert(`ç¾¤èŠ ${groupName} åˆ›å»ºæˆåŠŸï¼Œä»£ç : ${groupCode}`);
                
                // æ·»åŠ åˆ°ç”¨æˆ·ç¾¤èŠåˆ—è¡¨
                userGroups.push({ id: Date.now(), name: groupName, code: groupCode });
                updateGroupList();
                
                // å…³é—­æ¨¡æ€æ¡†å¹¶æ¸…ç©ºè¡¨å•
                createGroupModal.style.display = 'none';
                document.getElementById('groupName').value = '';
                document.getElementById('groupCode').value = '';
                document.getElementById('groupPassword').value = '';
            }).catch(error => {
                console.error('åˆ›å»ºç¾¤èŠé”™è¯¯:', error);
                alert('åˆ›å»ºç¾¤èŠå¤±è´¥');
            });
        }

        // åŠ å…¥ç¾¤èŠ
        function joinGroup() {
            const groupCode = document.getElementById('joinGroupCode').value;
            const groupPassword = document.getElementById('joinGroupPassword').value;
            
            if (!groupCode) {
                alert('è¯·è¾“å…¥ç¾¤ä»£ç ');
                return;
            }
            
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨APIåŠ å…¥ç¾¤èŠ
            joinChatGroup(groupCode, groupPassword).then(group => {
                if (group) {
                    alert(`æˆåŠŸåŠ å…¥ç¾¤èŠ: ${group.name}`);
                    
                    // æ·»åŠ åˆ°ç”¨æˆ·ç¾¤èŠåˆ—è¡¨
                    userGroups.push(group);
                    updateGroupList();
                    
                    // å…³é—­æ¨¡æ€æ¡†å¹¶æ¸…ç©ºè¡¨å•
                    joinGroupModal.style.display = 'none';
                    document.getElementById('joinGroupCode').value = '';
                    document.getElementById('joinGroupPassword').value = '';
                } else {
                    alert('åŠ å…¥ç¾¤èŠå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç¾¤ä»£ç å’Œå¯†ç ');
                }
            }).catch(error => {
                console.error('åŠ å…¥ç¾¤èŠé”™è¯¯:', error);
                alert('åŠ å…¥ç¾¤èŠå¤±è´¥');
            });
        }

        // æ¨¡æ‹ŸAPIåŠ å…¥ç¾¤èŠ
        async function joinChatGroup(groupCode, groupPassword) {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨çœŸå®çš„åç«¯API
            return new Promise((resolve) => {
                setTimeout(() => {
                    // æ¨¡æ‹ŸåŠ å…¥ç¾¤èŠ
                    if (groupCode === '1234') {
                        resolve({ id: 1, name: 'æŠ€æœ¯äº¤æµ', code: '1234' });
                    } else if (groupCode === '5678') {
                        resolve({ id: 2, name: 'æ¸¸æˆç¾¤', code: '5678' });
                    } else if (groupCode === '9012') {
                        resolve({ id: 3, name: 'å­¦ä¹ å°ç»„', code: '9012' });
                    } else {
                        resolve(null);
                    }
                }, 500);
            });
        }

        // æ¨¡æ‹ŸAPIåˆ›å»ºç¾¤èŠ
        async function createChatGroup(groupName, groupCode, groupPassword) {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨çœŸå®çš„åç«¯API
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log('åˆ›å»ºç¾¤èŠ:', groupName, groupCode);
                    resolve();
                }, 500);
            });
        }

        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            const notificationsEnabled = document.getElementById('notificationsEnabled').checked;
            const messageSoundEnabled = document.getElementById('messageSoundEnabled').checked;
            
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨APIä¿å­˜è®¾ç½®
            saveUserSettings(notificationsEnabled, messageSoundEnabled).then(() => {
                alert('è®¾ç½®å·²ä¿å­˜');
                settingsModal.style.display = 'none';
            }).catch(error => {
                console.error('ä¿å­˜è®¾ç½®é”™è¯¯:', error);
                alert('ä¿å­˜è®¾ç½®å¤±è´¥');
            });
        }

        // æ¨¡æ‹ŸAPIä¿å­˜è®¾ç½®
        async function saveUserSettings(notificationsEnabled, messageSoundEnabled) {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨çœŸå®çš„åç«¯API
            return new Promise((resolve) => {
                setTimeout(() => {
                    console.log('ä¿å­˜è®¾ç½®:', { notificationsEnabled, messageSoundEnabled });
                    resolve();
                }, 500);
            });
        }

        // åˆ‡æ¢ä¸»é¢˜
        function toggleTheme() {
            document.body.classList.toggle('dark-mode');
            themeToggle.textContent = document.body.classList.contains('dark-mode') ? 'â˜€ï¸' : 'ğŸŒ™';
            
            // ä¿å­˜ä¸»é¢˜åå¥½
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
        }

        // æ£€æŸ¥ç”¨æˆ·è§’è‰²
        function checkUserRole() {
            // æ£€æŸ¥æ˜¯å¦ä¸ºå¼€å‘è€…
            if (currentUser.username === DEVELOPER_CREDENTIALS.username) {
                isDeveloper = true;
                userBadge.textContent = "å¼€å‘è€…";
                userBadge.style.display = "block";
                userBadge.classList.add("badge-dev");
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
            if (currentUser.isAdmin) {
                isAdmin = true;
                userBadge.textContent = "ç®¡ç†å‘˜";
                userBadge.style.display = "block";
                userBadge.classList.add("badge-admin");
            }
            
            // æ£€æŸ¥ä¿å­˜çš„ä¸»é¢˜åå¥½
            if (localStorage.getItem('darkMode') === 'true') {
                document.body.classList.add('dark-mode');
                themeToggle.textContent = 'â˜€ï¸';
            }
        }

        // é€šçŸ¥æœåŠ¡å™¨ç”¨æˆ·åŠ å…¥
        function notifyUserJoin() {
            // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥è°ƒç”¨APIé€šçŸ¥æœåŠ¡å™¨ç”¨æˆ·åŠ å…¥
            console.log('ç”¨æˆ·åŠ å…¥:', currentUser.username);
        }

        // å·¥å…·å‡½æ•°ï¼šç”Ÿæˆç”¨æˆ·ID
        function generateUserId() {
            return Math.floor(Math.random() * 1000000000).toString();
        }

        // å·¥å…·å‡½æ•°ï¼šç”Ÿæˆç¾¤ä»£ç 
        function generateGroupCode() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }
    </script>
</body>
</html>